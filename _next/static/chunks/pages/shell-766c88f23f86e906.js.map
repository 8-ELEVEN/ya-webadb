{"version":3,"file":"static/chunks/pages/shell-766c88f23f86e906.js","mappings":"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","sources":["webpack://_N_E/?6d1b","webpack://_N_E/./src/components/terminal.tsx","webpack://_N_E/./src/pages/shell.tsx","webpack://_N_E/<anon>"],"sourcesContent":["\n    (window.__NEXT_P = window.__NEXT_P || []).push([\n      \"/shell\",\n      function () {\n        return require(\"private-next-pages/shell.tsx\");\n      }\n    ]);\n    if(module.hot) {\n      module.hot.dispose(function () {\n        window.__NEXT_P.push([\"/shell\"])\n      });\n    }\n  ","// cspell: ignore scrollback\n\nimport { AdbSubprocessProtocol, encodeUtf8 } from \"@yume-chan/adb\";\nimport { AutoDisposable } from \"@yume-chan/event\";\nimport {\n    AbortController,\n    Consumable,\n    WritableStream,\n} from \"@yume-chan/stream-extra\";\nimport { Terminal } from \"xterm\";\nimport { FitAddon } from \"xterm-addon-fit\";\nimport { SearchAddon } from \"xterm-addon-search\";\nimport { WebglAddon } from \"xterm-addon-webgl\";\n\nexport class AdbTerminal extends AutoDisposable {\n    private element = document.createElement(\"div\");\n\n    public terminal: Terminal = new Terminal({\n        allowProposedApi: true,\n        allowTransparency: true,\n        cursorStyle: \"bar\",\n        cursorBlink: true,\n        fontFamily:\n            '\"Cascadia Code\", Consolas, monospace, \"Source Han Sans SC\", \"Microsoft YaHei\"',\n        letterSpacing: 1,\n        scrollback: 9000,\n        smoothScrollDuration: 50,\n        overviewRulerWidth: 20,\n    });\n\n    public searchAddon = new SearchAddon();\n\n    private readonly fitAddon = new FitAddon();\n\n    private _socket: AdbSubprocessProtocol | undefined;\n    private _socketAbortController: AbortController | undefined;\n    public get socket() {\n        return this._socket;\n    }\n    public set socket(value) {\n        if (this._socket) {\n            // Remove event listeners\n            this.dispose();\n            this._socketAbortController?.abort();\n        }\n\n        this._socket = value;\n\n        if (value) {\n            this.terminal.clear();\n            this.terminal.reset();\n\n            this._socketAbortController = new AbortController();\n\n            // pty mode only has one stream\n            value.stdout\n                .pipeTo(\n                    new WritableStream<Uint8Array>({\n                        write: (chunk) => {\n                            this.terminal.write(chunk);\n                        },\n                    }),\n                    {\n                        signal: this._socketAbortController.signal,\n                    }\n                )\n                .catch(() => {});\n\n            const _writer = value.stdin.getWriter();\n            this.addDisposable(\n                this.terminal.onData((data) => {\n                    const buffer = encodeUtf8(data);\n                    const output = new Consumable(buffer);\n                    _writer.write(output);\n                })\n            );\n\n            this.fit();\n        }\n    }\n\n    public constructor() {\n        super();\n\n        this.element.style.width = \"100%\";\n        this.element.style.height = \"100%\";\n        this.element.style.overflow = \"hidden\";\n\n        this.terminal.loadAddon(this.searchAddon);\n        this.terminal.loadAddon(this.fitAddon);\n    }\n\n    public setContainer(container: HTMLDivElement) {\n        container.appendChild(this.element);\n        if (!this.terminal.element) {\n            void this.element.offsetWidth;\n            this.terminal.open(this.element);\n            // WebGL addon requires terminal to be attached to DOM\n            this.terminal.loadAddon(new WebglAddon());\n            // WebGL renderer ignores `cursorBlink` set before it initialized\n            this.terminal.options.cursorBlink = true;\n            this.fit();\n        }\n    }\n\n    public fit() {\n        this.fitAddon.fit();\n        // Resize remote terminal\n        const { rows, cols } = this.terminal;\n        this._socket?.resize(rows, cols);\n    }\n}\n","import { IconButton, SearchBox, Stack, StackItem } from \"@fluentui/react\";\nimport { makeStyles, shorthands } from \"@griffel/react\";\nimport { action, autorun, makeAutoObservable, runInAction } from \"mobx\";\nimport { observer } from \"mobx-react-lite\";\nimport { NextPage } from \"next\";\nimport Head from \"next/head\";\nimport { useCallback, useEffect } from \"react\";\nimport { ISearchOptions } from \"xterm-addon-search\";\nimport \"xterm/css/xterm.css\";\nimport { ResizeObserver } from \"../components\";\nimport { GLOBAL_STATE } from \"../state\";\nimport { Icons, RouteStackProps } from \"../utils\";\n\nconst useClasses = makeStyles({\n    count: {\n        ...shorthands.padding(\"0\", \"8px\"),\n    },\n});\n\nlet terminal: import(\"../components/terminal\").AdbTerminal | undefined;\nif (typeof window !== \"undefined\") {\n    const { AdbTerminal } = require(\"../components/terminal\");\n    terminal = new AdbTerminal();\n}\n\nconst SEARCH_OPTIONS: ISearchOptions = {\n    decorations: {\n        matchBackground: \"#42557b\",\n        matchOverviewRuler: \"#d18616\",\n        activeMatchBackground: \"#6199ff2f\",\n        activeMatchColorOverviewRuler: \"#d186167e\",\n    },\n};\n\nconst state = makeAutoObservable(\n    {\n        visible: false,\n        index: undefined as number | undefined,\n        count: undefined as number | undefined,\n        setVisible(value: boolean) {\n            this.visible = value;\n        },\n\n        searchKeyword: \"\",\n        setSearchKeyword(value: string) {\n            this.searchKeyword = value;\n            terminal!.searchAddon.findNext(value, {\n                ...SEARCH_OPTIONS,\n                incremental: true,\n            });\n        },\n\n        searchPrevious() {\n            terminal!.searchAddon.findPrevious(\n                this.searchKeyword,\n                SEARCH_OPTIONS\n            );\n        },\n        searchNext() {\n            terminal!.searchAddon.findNext(this.searchKeyword, SEARCH_OPTIONS);\n        },\n    },\n    {\n        searchPrevious: action.bound,\n        searchNext: action.bound,\n    }\n);\n\nif (terminal) {\n    terminal.searchAddon.onDidChangeResults((e) => {\n        console.log(e);\n\n        runInAction(() => {\n            if (e) {\n                state.index = e.resultIndex;\n                state.count = e.resultCount;\n            } else {\n                state.index = undefined;\n                state.count = undefined;\n            }\n        });\n    });\n}\n\nautorun(() => {\n    if (!terminal) {\n        return;\n    }\n\n    if (!GLOBAL_STATE.device) {\n        terminal.socket = undefined;\n        return;\n    }\n\n    if (!terminal.socket && state.visible) {\n        GLOBAL_STATE.device.subprocess.shell().then(\n            action((shell) => {\n                terminal!.socket = shell;\n            }),\n            (e) => {\n                GLOBAL_STATE.showErrorDialog(e);\n            }\n        );\n    }\n});\n\nconst UpIconProps = { iconName: Icons.ChevronUp };\nconst DownIconProps = { iconName: Icons.ChevronDown };\n\nconst Shell: NextPage = (): JSX.Element | null => {\n    const classes = useClasses();\n\n    const handleSearchKeywordChange = useCallback(\n        (e: unknown, value?: string) => {\n            state.setSearchKeyword(value ?? \"\");\n        },\n        []\n    );\n\n    const handleResize = useCallback(() => {\n        terminal!.fit();\n    }, []);\n\n    const handleContainerRef = useCallback(\n        (container: HTMLDivElement | null) => {\n            if (container) {\n                terminal!.setContainer(container);\n            }\n        },\n        []\n    );\n\n    useEffect(() => {\n        state.setVisible(true);\n        return () => {\n            state.setVisible(false);\n        };\n    }, []);\n\n    return (\n        <Stack {...RouteStackProps}>\n            <Head>\n                <title>Interactive Shell - Android Web Toolbox</title>\n            </Head>\n\n            <StackItem>\n                <Stack horizontal>\n                    <StackItem grow>\n                        <SearchBox\n                            placeholder=\"Find\"\n                            value={state.searchKeyword}\n                            onChange={handleSearchKeywordChange}\n                            onSearch={state.searchNext}\n                        />\n                    </StackItem>\n                    {state.count === 0 ? (\n                        <StackItem className={classes.count} align=\"center\">\n                            No results\n                        </StackItem>\n                    ) : state.count !== undefined ? (\n                        <StackItem className={classes.count} align=\"center\">\n                            {state.index! + 1} of {state.count}\n                        </StackItem>\n                    ) : null}\n                    <StackItem>\n                        <IconButton\n                            disabled={!state.searchKeyword}\n                            iconProps={UpIconProps}\n                            onClick={state.searchPrevious}\n                        />\n                    </StackItem>\n                    <StackItem>\n                        <IconButton\n                            disabled={!state.searchKeyword}\n                            iconProps={DownIconProps}\n                            onClick={state.searchNext}\n                        />\n                    </StackItem>\n                </Stack>\n            </StackItem>\n\n            <StackItem\n                grow\n                styles={{ root: { position: \"relative\", minHeight: 0 } }}\n            >\n                <ResizeObserver onResize={handleResize} />\n                <div ref={handleContainerRef} style={{ height: \"100%\" }} />\n            </StackItem>\n        </Stack>\n    );\n};\n\nexport default observer(Shell);\n"],"names":["window","__NEXT_P","push","__webpack_require__","AdbTerminal","AutoDisposable","socket","_socket","value","_this__socketAbortController","dispose","_socketAbortController","abort","terminal","clear","reset","AbortController","stdout","pipeTo","WritableStream","write","chunk","signal","catch","_writer","stdin","getWriter","addDisposable","onData","buffer","encodeUtf8","data","output","Consumable","fit","setContainer","container","appendChild","element","offsetWidth","open","loadAddon","WebglAddon","options","cursorBlink","_this__socket","fitAddon","rows","cols","resize","constructor","document","createElement","Terminal","allowProposedApi","allowTransparency","cursorStyle","fontFamily","letterSpacing","scrollback","smoothScrollDuration","overviewRulerWidth","searchAddon","SearchAddon","FitAddon","style","width","height","overflow","useClasses","makeStyles","count","shorthands","require","SEARCH_OPTIONS","decorations","matchBackground","matchOverviewRuler","activeMatchBackground","activeMatchColorOverviewRuler","state","makeAutoObservable","visible","index","undefined","setVisible","searchKeyword","setSearchKeyword","findNext","incremental","searchPrevious","findPrevious","searchNext","action","onDidChangeResults","console","log","e","runInAction","resultIndex","resultCount","autorun","GLOBAL_STATE","then","shell","UpIconProps","iconName","Icons","DownIconProps","Shell","classes","handleSearchKeywordChange","useCallback","handleResize","handleContainerRef","useEffect","react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__","jsxs","Stack","RouteStackProps","jsx","Head","title","StackItem","horizontal","grow","SearchBox","placeholder","onChange","onSearch","className","align","IconButton","disabled","iconProps","onClick","styles","root","position","minHeight","ResizeObserver","onResize","div","ref","__webpack_exports__","observer"],"sourceRoot":""}